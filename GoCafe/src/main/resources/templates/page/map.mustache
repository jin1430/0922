{{>layout/header}}

<main class="cg-container">
    <!-- 헤더 -->
    <header class="cg-map-header" style="display:flex;justify-content:space-between;align-items:center;margin:20px 0;">
        <h1 class="cg-title">CafeGo Map</h1>
        <a href="/mypage" class="cg-link">마이페이지</a>
    </header>

    <!-- 검색 -->
    <div class="cg-search-box" style="display:flex;gap:8px;margin-bottom:20px;">
        <input type="text" class="cg-search-input" placeholder="주소 또는 장소 입력"
               style="flex:1;padding:10px;border:1px solid var(--line,#dbe7e2);border-radius:8px;">
        <button class="cg-search-btn"
                style="padding:10px 16px;background:var(--mint,#3aa17e);color:var(--white,#fff);border:none;border-radius:8px;font-weight:700;cursor:pointer;">
            검색
        </button>
    </div>

    <!-- 지도 + 인기 장소 -->
    <div class="cg-map-content" style="display:flex;gap:24px;">
        <div class="cg-map-area" style="flex:2;">
            <div id="map" style="width:100%;height:480px;border-radius:12px;border:1px solid var(--line,#dbe7e2);"></div>
        </div>

        <aside class="cg-popular-places" style="flex:1;background:var(--mint-weak,#e8f3ee);padding:16px;border-radius:12px;">
            <h2 class="cg-subtitle" style="margin:0 0 12px;color:var(--text,#1e2a2a);font-size:18px;">주변 인기 장소</h2>
            <ul class="cg-place-list" style="list-style:none;margin:0;padding:0;">
                {{#places}}
                    <li class="cg-place-item" style="padding:10px 0;border-bottom:1px solid var(--line,#dbe7e2);">
                        <div class="cg-place-name" style="font-weight:700;margin-bottom:4px;">{{name}}</div>
                        <div class="cg-place-rating" style="color:var(--muted,#5b6a6a);font-size:14px;">⭐ {{rating}}</div>
                    </li>
                {{/places}}
                {{^places}}
                    <li class="cg-place-item" style="padding:10px 0;color:var(--muted,#5b6a6a);">표시할 장소가 없습니다.</li>
                {{/places}}
            </ul>
        </aside>
    </div>
</main>

<!-- 모달 -->
<div id="placeModal" class="cg-modal" aria-hidden="true"
     style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1000;">
    <div class="cg-modal__overlay" data-close="true"
         style="position:absolute;inset:0;background:rgba(0,0,0,.4);"></div>
    <div class="cg-modal__content" role="dialog" aria-modal="true" aria-labelledby="placeTitle"
         style="position:relative;background:var(--white,#fff);width:min(520px,92vw);border:1px solid var(--line,#dbe7e2);
              border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden;">
        <div style="display:flex;gap:14px;align-items:center;padding:16px 18px;background:var(--mint-weak,#e8f3ee);">
            <div id="placeThumb" style="width:64px;height:64px;border-radius:12px;background:#ddd;flex:none;"></div>
            <div style="flex:1;">
                <h3 id="placeTitle" style="margin:0 0 6px;font-size:18px;color:var(--text,#1e2a2a);"></h3>
                <div id="placeRating" style="font-size:14px;color:var(--muted,#5b6a6a);"></div>
            </div>
            <button class="cg-btn-close" data-close="true"
                    style="border:none;background:transparent;font-size:20px;line-height:1;cursor:pointer;">✕</button>
        </div>
        <div style="padding:16px 18px;">
            <div id="placeAddr" style="margin-bottom:10px;color:var(--text,#1e2a2a);"></div>
            <div id="placeTags" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px;"></div>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
                <a id="placeDetailLink" href="#" class="cg-btn-primary"
                   style="text-decoration:none;padding:10px 14px;background:var(--mint,#3aa17e);color:#fff;border-radius:10px;font-weight:700;">
                    자세히 보기
                </a>
            </div>
        </div>
    </div>
</div>

{{>layout/footer}}

<!-- Kakao Maps SDK: 앱 키 교체 필수 -->
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey="></script>
<script>
    // ----- 서버에서 내려준 데이터 -----
    const PLACES  = {{&placesJson}}   || [];
  const ANCHORS = {{&anchorsJson}}  || [];

  // ----- 지도 생성 -----
  const map = new kakao.maps.Map(document.getElementById('map'), {
    center: new kakao.maps.LatLng(37.553, 126.921), // 초기값 (곧 bounds로 조정)
    level: 5
  });

  // ----- 모달 핸들러 -----
  const modal   = document.getElementById('placeModal');
  const elTitle = document.getElementById('placeTitle');
  const elRating= document.getElementById('placeRating');
  const elAddr  = document.getElementById('placeAddr');
  const elTags  = document.getElementById('placeTags');
  const elThumb = document.getElementById('placeThumb');
  const elDetail= document.getElementById('placeDetailLink');

  function openModal(place) {
    elTitle.textContent = place.name || '';
    elRating.textContent = place.rating ? `⭐ ${place.rating}` : '';
    elAddr.textContent = place.address || '';
    elTags.innerHTML = (place.tags || []).map(t =>
      `<span style="padding:4px 8px;border-radius:999px;background:var(--mint-weak,#e8f3ee);
                     color:var(--text,#1e2a2a);font-size:12px;">#${t}</span>`).join('');
    elThumb.style.background = place.thumbnail ? `center/cover url(${place.thumbnail})` : '#ddd';
    elDetail.href = `/cafe/${place.id || ''}`;
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
  }
  function closeModal() { modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); }
  modal.addEventListener('click', e => { if (e.target.dataset.close !== undefined) closeModal(); });
  window.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

  // ----- 마커 & 바운즈 -----
  const bounds = new kakao.maps.LatLngBounds();

  // 앵커(홍대입구/상수/연트럴/합정)는 빨간 마커로
  const anchorMarkerImg = new kakao.maps.MarkerImage(
    'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png',
    new kakao.maps.Size(24, 35)
  );
  ANCHORS.forEach(a => {
    const pos = new kakao.maps.LatLng(a.lat, a.lng);
    bounds.extend(pos);
    new kakao.maps.Marker({ map, position: pos, title: a.name, image: anchorMarkerImg });
  });

  // 장소 마커 (클릭 시 모달)
  PLACES.forEach(p => {
    const pos = new kakao.maps.LatLng(p.lat, p.lng);
    bounds.extend(pos);
    const m = new kakao.maps.Marker({ map, position: pos, title: p.name });
    kakao.maps.event.addListener(m, 'click', () => openModal(p));
  });

  // 모든 포인트가 한 화면에 보이도록
  if (!bounds.isEmpty()) map.setBounds(bounds);
  // setTimeout(() => map.relayout(), 50); // 필요한 경우 레이아웃 재계산
</script>
